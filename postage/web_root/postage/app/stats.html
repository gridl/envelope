<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-GB">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="pragma" content="no-cache" />
        <meta http-equiv="Expires" content="-1" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        
        <link rel="apple-touch-startup-image" href="/public/images/el_portrait.png" />
        <link rel="apple-touch-icon" href="/public/images/el_touch_icon.png" />
        
        <script src="/js/greyspots.js" type="text/javascript"></script>
        <link href="/css/greyspots.css" type="text/css" rel="stylesheet">
        
        <script src="/js/d3.js"></script>
        
        <title>Statistics</title>
        <style>
        /*
            .axis--x path {
                display: none;
            }
            */
            .line_1 {
                fill: none;
                stroke: #FF8888;
                stroke-width: 1.5px;
            }
            .line_2 {
                fill: none;
                stroke: #88FF88;
                stroke-width: 1.5px;
            }
            .line_3 {
                fill: none;
                stroke: #8888FF;
                stroke-width: 1.5px;
            }
        </style>
        <script>
/*jslint browser*/
/*global window, GS, d3, console*/
var Global = {};

function startData() {
    "use strict";
    Global.svg = d3.select("svg");

    Global.margin = {top: 20, right: 20, bottom: 30, left: 50};
    Global.width = +Global.svg.attr("width") - Global.margin.left - Global.margin.right;
    Global.height = +Global.svg.attr("height") - Global.margin.top - Global.margin.bottom;

    Global.g = Global.svg.append("g").attr("transform", "translate(" + Global.margin.left + "," + Global.margin.top + ")")
        .attr("id", "master_g");

    Global.x = d3.scaleLinear()
        .rangeRound([0, Global.width]);

    Global.y = d3.scaleLinear()
        .rangeRound([Global.height, 0]);

    Global.line_1_f = d3.line()
        .x(function (d) {
            return Global.x(d.x);
        })
        .y(function (d) {
            return Global.y(d.total_1);
        });

    Global.line_2_f = d3.line()
        .x(function (d) {
            return Global.x(d.x);
        })
        .y(function (d) {
            return Global.y(d.total_2);
        });

    Global.line_3_f = d3.line()
        .x(function (d) {
            return Global.x(d.x);
        })
        .y(function (d) {
            return Global.y(d.total_3);
        });

    Global.x.domain([0, 40]);

    //append x axis
    Global.axis_x = Global.g.append("g")
        .attr("id", "axis_x")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + Global.height + ")")
        .call(d3.axisBottom(Global.x));

    //append y axis
    Global.axis_y = Global.g.append("g")
        .attr("id", "axis_y")
        .attr("class", "axis axis--y")
        .call(d3.axisLeft(Global.y));

    //append total label
    Global.axis_y.append("text")
        .attr("id", "text_label_1")
        .attr("fill", "#ff8888")
        //.attr("transform", "rotate(-90)")
        .attr("x", 25)
        .attr("y", 10)
        .attr("dy", "0.71em")
        .style("text-anchor", "start")
        .style("font-family", "Helvetica Bold")
        .style("font-size", "20px")
        .text("Total");

    //append active label
    Global.axis_y.append("text")
        .attr("id", "text_label_2")
        .attr("fill", "#88ff88")
        //.attr("transform", "rotate(-90)")
        .attr("x", 25)
        .attr("y", 30)
        .attr("dy", "0.71em")
        .style("text-anchor", "start")
        .style("font-family", "Helvetica Bold")
        .style("font-size", "20px")
        .text("Active");

    //append inactive label
    Global.axis_y.append("text")
        .attr("id", "text_label_3")
        .attr("fill", "#8888ff")
        //.attr("transform", "rotate(-90)")
        .attr("x", 25)
        .attr("y", 50)
        .attr("dy", "0.71em")
        .style("text-anchor", "start")
        .style("font-family", "Helvetica Bold")
        .style("font-size", "20px")
        .text("Inactive");

    //append holder
    var holder = Global.svg.append("defs");
    holder.append("svg:clipPath")
        .attr("id", "innerGraph")
        .append("svg:rect")
        .attr("x", 0)
        .attr("y", 0)
        .style("fill", "gray")
        .attr("height", Global.height)
        .attr("width", Global.width);

    console.log('test1');

    //append active line
    Global.line_1 = Global.g.append("path")
        .attr("clip-path", "url(#innerGraph)")
        .attr("id", "line_1")
        .attr("class", "line_1");

    console.log('test2');

    //append active line
    Global.line_2 = Global.g.append("path")
        .attr("clip-path", "url(#innerGraph)")
        .attr("id", "line_2")
        .attr("class", "line_2");

    console.log('test3');

    //append inactive line
    Global.line_3 = Global.g.append("path")
        .attr("clip-path", "url(#innerGraph)")
        .attr("id", "line_3")
        .attr("class", "line_3");

    console.log('test4');
}


function newData(data) {
    "use strict";
    //prepare arr_total with data in format that lines will understand
    var i = 0;
    var len = data.length;
    var arr_total = [];
    while (i < len) {
        arr_total.push({
            x: i,
            total_1: data[i][0],
            total_2: data[i][1],
            total_3: data[i][2]
        });

        i += 1;
    }

    //get the minimum and maximum of the date and set the minimum and maximum of the chart
    var extent_0 = d3.extent(arr_total, function (d) {
        return d.x;
    });

    extent_0[0] = Math.min(extent_0[0], 0);

    //x.domain(extent_0);
    Global.x.domain([0, 40]);

    //get the minimum and maximum of the three lines and set the minimum and maximum of the chart
    var extent_1 = d3.extent(arr_total, function (d) {
        return d.total_1;
    });
    var extent_2 = d3.extent(arr_total, function (d) {
        return d.total_2;
    });
    var extent_3 = d3.extent(arr_total, function (d) {
        return d.total_3;
    });

    extent_1[0] = Math.min(extent_1[0], 0);
    extent_2[0] = Math.min(extent_2[0], 0);
    extent_3[0] = Math.min(extent_3[0], 0);

    Global.y.domain([Math.min(extent_1[0], extent_2[0], extent_3[0]), Math.max(extent_1[1], extent_2[1], extent_3[1])]);

    console.log(extent_0);
    console.log(extent_1);
    console.log(extent_2);
    console.log(extent_3);

    //append x axis
    Global.axis_x
        .call(d3.axisBottom(Global.x));

    Global.axis_x.enter();
    Global.axis_x.exit();

    //append y axis
    Global.axis_y
        .call(d3.axisLeft(Global.y));

    Global.axis_x.enter();
    Global.axis_y.exit();

    console.log(arr_total);

    Global.line_1
        .datum(arr_total)
        .attr("d", Global.line_1_f)
        .attr("transform", null)
        .transition()
        .duration(950)
        .attr("transform", "translate(" + (Global.x(0) - Global.x(1)) + ")");

    Global.line_2
        .datum(arr_total)
        .attr("d", Global.line_2_f)
        .attr("transform", null)
        .transition()
        .duration(950)
        .attr("transform", "translate(" + (Global.x(0) - Global.x(1)) + ")");

    Global.line_3
        .datum(arr_total)
        .attr("d", Global.line_3_f)
        .attr("transform", null)
        .transition()
        .duration(950)
        .attr("transform", "translate(" + (Global.x(0) - Global.x(1)) + ")");
}
/*
function newData(data) {
    "use strict";
    //d3
    var svg = d3.select("svg");

    var margin = {top: 20, right: 20, bottom: 30, left: 50};
    var width = +svg.attr("width") - margin.left - margin.right;
    var height = +svg.attr("height") - margin.top - margin.bottom;

    var g = d3.select('master_g');

    console.log('g', g);

    g = document.getElementById("master_g");
    g.parentNode.removeChild(g);

    console.log('g', g);
    console.log('document.getElementById("master_g")', document.getElementById("master_g"));

    g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .attr("id", "master_g");

    var x = d3.scaleLinear()
        .rangeRound([0, width]);

    var y = d3.scaleLinear()
        .rangeRound([height, 0]);

    var line_1 = d3.line()
        .x(function (d) {
            return x(d.x);
        })
        .y(function (d) {
            return y(d.total_1);
        });

    var line_2 = d3.line()
        .x(function (d) {
            return x(d.x);
        })
        .y(function (d) {
            return y(d.total_2);
        });

    var line_3 = d3.line()
        .x(function (d) {
            return x(d.x);
        })
        .y(function (d) {
            return y(d.total_3);
        });

    //prepare arr_total with data in format that lines will understand
    var i = 0;
    var len = data.length;
    var arr_total = [];
    while (i < len) {
        arr_total.push({
            x: i,
            total_1: data[i][0],
            total_2: data[i][1],
            total_3: data[i][2]
        });

        i += 1;
    }

    //get the minimum and maximum of the date and set the minimum and maximum of the chart
    var extent_0 = d3.extent(arr_total, function (d) {
        return d.x;
    });

    extent_0[0] = Math.min(extent_0[0], 0);

    //x.domain(extent_0);
    x.domain([0, 40]);

    //get the minimum and maximum of the three lines and set the minimum and maximum of the chart
    var extent_1 = d3.extent(arr_total, function (d) {
        return d.total_1;
    });
    var extent_2 = d3.extent(arr_total, function (d) {
        return d.total_2;
    });
    var extent_3 = d3.extent(arr_total, function (d) {
        return d.total_3;
    });

    extent_1[0] = Math.min(extent_1[0], 0);
    extent_2[0] = Math.min(extent_2[0], 0);
    extent_3[0] = Math.min(extent_3[0], 0);

    y.domain([Math.min(extent_1[0], extent_2[0], extent_3[0]), Math.max(extent_1[1], extent_2[1], extent_3[1])]);

    console.log(extent_0);
    console.log(extent_1);
    console.log(extent_2);
    console.log(extent_3);

    //append x axis
    g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

    //append y axis
    var axis_y = g.append("g")
        .attr("class", "axis axis--y")
        .call(d3.axisLeft(y));

    //append total label
    axis_y.append("text")
        .attr("id", "text_label_1")
        .attr("fill", "#ff8888")
        //.attr("transform", "rotate(-90)")
        .attr("x", 25)
        .attr("y", 10)
        .attr("dy", "0.71em")
        .style("text-anchor", "start")
        .style("font-family", "Helvetica Bold")
        .style("font-size", "20px")
        .text("Total");

    //append active label
    axis_y.append("text")
        .attr("id", "text_label_2")
        .attr("fill", "#88ff88")
        //.attr("transform", "rotate(-90)")
        .attr("x", 25)
        .attr("y", 30)
        .attr("dy", "0.71em")
        .style("text-anchor", "start")
        .style("font-family", "Helvetica Bold")
        .style("font-size", "20px")
        .text("Active");

    //append inactive label
    axis_y.append("text")
        .attr("id", "text_label_3")
        .attr("fill", "#8888ff")
        //.attr("transform", "rotate(-90)")
        .attr("x", 25)
        .attr("y", 50)
        .attr("dy", "0.71em")
        .style("text-anchor", "start")
        .style("font-family", "Helvetica Bold")
        .style("font-size", "20px")
        .text("Inactive");

    console.log(arr_total);

    //append total line
    g.append("path")
        .attr("id", "line_1")
        .datum(arr_total)
        .attr("class", "line_1")
        .attr("d", line_1);

    //append active line
    g.append("path")
        .attr("id", "line_2")
        .datum(arr_total)
        .attr("class", "line_2")
        .attr("d", line_2);

    //append inactive line
    g.append("path")
        .attr("id", "line_3")
        .datum(arr_total)
        .attr("class", "line_3")
        .attr("d", line_3);
}
*/
window.addEventListener('load', function () {
    "use strict";

    var connectionsData = d3.range(0, 43).map(function () {
        return [0, 0, 0];
    });

    startData();

    Global.interval = setInterval(function () {
        GS.ajaxJSON(
            '/env/action_select',
            'src=' + encodeURIComponent('(SELECT count(*) AS total_connections, ' +
                    'sum(CASE WHEN state =  \'active\' THEN 1 ELSE 0 END) AS active_connections, ' +
                    'sum(CASE WHEN state <> \'active\' THEN 1 ELSE 0 END) AS inactive_connections ' +
                    'FROM pg_catalog.pg_stat_activity) em'),
            function (data, error) {

                if (!error) {
                    //document.getElementById('result').textContent = JSON.stringify(data.dat);

                    console.log(data.dat.dat[0]);
                    connectionsData.push(data.dat.dat[0]);
                    console.log(connectionsData);

                    while (connectionsData.length > 42) {
                        connectionsData.shift();
                    }

                    newData(connectionsData);

                } else {
                    GS.ajaxErrorDialog(data);
                }
            }
        );
    }, 1000);
});
        </script>
    </head>
    <body>
    <br/>
        <svg width="960" height="500">
        </svg>
    </body>
</html>